<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PMW25 Certificate Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Poppins',sans-serif; background:#f3f3f3; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; margin:0; padding:20px;}
h1 { font-size:26px; font-weight:700; margin-bottom:20px; text-align:center;}
.page { display:none; flex-direction:column; align-items:center;}
.active { display:flex;}
input[type=text]{padding:10px 15px; font-size:18px; width:320px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;}
button{padding:10px 20px; font-size:16px; border:none; border-radius:6px; background:#007bff; color:#fff; cursor:pointer; margin-top:10px;}
button:hover{background:#0056b3;}
.certificate-container{position:relative; width:100%; max-width:1500px; border:2px solid #ddd; background:#fff; box-shadow:0 0 10px rgba(0,0,0,0.1); margin-top:20px;}
#certificateImage{width:100%; display:block;}
#namePreview{position:absolute; left:50%; top:53%; transform:translate(-50%,-50%); font-size:clamp(13px,3vw,40px); font-weight:530; text-align:center; white-space:nowrap;}
#pmiLogo{width:120px; margin-bottom:20px;}
#validationFeedback{margin-top:5px; font-size:16px;}
.valid{color:green;}
.invalid{color:red;}
</style>
</head>
<body>
<img src="pmi logo.png" id="pmiLogo">
<h1>PMW25 Certificate Generator</h1>
<div class="page active" id="validationPage">
  <label>Enter your name for validation</label>
  <input type="text" id="validateNameInput" placeholder="Eg. Vitus Watson"/>
  <button id="validateBtn">Validate</button>
  <div id="validationFeedback"></div>
</div>
<div class="page" id="certificatePage">
  <input type="text" id="certNameInput" placeholder="Enter name for certificate"/>
  <button id="downloadBtn">Download Certificate</button>
  <div class="certificate-container">
    <img id="certificateImage" src="CERTIFICATES.jpg">
    <div id="namePreview">Your Name</div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
let participants = [];
let downloaded = JSON.parse(localStorage.getItem('pmw25_downloaded')||'[]');

// Load CSV
Papa.parse("participants.csv", {
  download:true,
  header:true,
  skipEmptyLines:true,
  delimiter:";",
  complete:function(results){
    participants = results.data.map(r => (r.name||'').trim().toLowerCase());
    console.log("Participants:", participants);
  }
});

function normalizeName(name){return name.toLowerCase().replace(/\s+/g,' ').trim();}

function isValidParticipant(name){
  const words = normalizeName(name).split(' ').filter(w => !['dr','eng','mr','ms','mrs'].includes(w));
  return participants.some(p=>{
    const pw = normalizeName(p).split(' ').filter(w=>!['dr','eng','mr','ms','mrs'].includes(w));
    return words.every(w=>pw.includes(w));
  });
}

const validateBtn = document.getElementById("validateBtn");
const validateNameInput = document.getElementById("validateNameInput");
const feedback = document.getElementById("validationFeedback");
const validationPage = document.getElementById("validationPage");
const certificatePage = document.getElementById("certificatePage");
const certNameInput = document.getElementById("certNameInput");
const namePreview = document.getElementById("namePreview");
const downloadBtn = document.getElementById("downloadBtn");

let attempts = {};

validateBtn.addEventListener("click", ()=>{
  const name = validateNameInput.value.trim();
  const nName = normalizeName(name);
  feedback.textContent='';
  if(!name){feedback.textContent='Enter your name'; feedback.className='invalid'; return;}
  if(downloaded.includes(nName)){feedback.textContent='Already downloaded'; feedback.className='invalid'; return;}
  if(!attempts[nName]) attempts[nName]=0;
  if(attempts[nName]>=2){feedback.textContent='Too many attempts'; feedback.className='invalid'; return;}
  if(!isValidParticipant(name)){
    attempts[nName]++;
    localStorage.setItem('pmw25_attempts',JSON.stringify(attempts));
    feedback.textContent='Name not found';
    feedback.className='invalid';
    return;
  }

  // Successful
  feedback.textContent='Name validated âœ”';
  feedback.className='valid';
  setTimeout(()=>{
    validationPage.classList.remove('active');
    certificatePage.classList.add('active');
    certNameInput.value='';
    namePreview.textContent='Your Name';
  },500);
});

certNameInput.addEventListener("input",()=>{
  namePreview.textContent=certNameInput.value||'Your Name';
});

downloadBtn.addEventListener("click",()=>{
  const name = certNameInput.value.trim();
  if(!name) return;
  html2canvas(document.querySelector('.certificate-container'),{scale:4}).then(canvas=>{
    const link = document.createElement('a');
    link.download=name.replace(/[^a-z0-9]/gi,'_')+'.jpg';
    link.href=canvas.toDataURL('image/jpeg',1.0);
    link.click();

    // mark as downloaded
    downloaded.push(normalizeName(name));
    localStorage.setItem('pmw25_downloaded',JSON.stringify(downloaded));

    // open fresh thank-you page
    const ty = window.open('','_blank','width=500,height=300');
    ty.document.write('<html><head><title></title><style>body{display:flex;justify-content:center;align-items:center;height:100vh;font-family:Poppins,sans-serif;background:#f3f3f3;margin:0;}h1{text-align:center;color:#007bff;}</style></head><body><h1>Thank you for participating PMW25!</h1></body></html>');
    ty.document.close();

    certificatePage.classList.remove('active');
    validationPage.classList.add('active');
  });
});
</script>
</body>
</html>
